// GoMart E-commerce Platform - Unified User Schema
// MongoDB Database Configuration - Simplified user system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Unified User Entity - Anyone can buy, sell, and message
model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  firstName   String
  lastName    String
  email       String   @unique
  phoneNumber String   @unique
  password    String
  region      String   // Ghana regions: Greater Accra, Ashanti, etc.
  city        String
  address     String
  
  // Optional vendor fields (for users who sell)
  businessName      String?  // Store/business name if selling
  businessLicense   String?
  taxId             String?
  storeDescription  String?
  storeLogo         String?
  storeBanner       String?
  whatsappNumber    String?
  instagramHandle   String?
  facebookPage      String?
  payoutMethod      String?
  mobileMoneyNetwork String?
  mobileMoneyNumber  String?
  bankName          String?
  bankAccountName   String?
  bankAccountNumber String?
  deliveryRegions   String[] @default([])
  isSeller          Boolean  @default(false) // True if user sells products
  isVerified        Boolean  @default(false) // Verified seller
  
  joinedDate  DateTime @default(now())
  isActive    Boolean  @default(true)
  rating      Float?   // Average rating as seller
  
  // Relationships
  products            Product[]          // Products user is selling
  reviews             Review[]           // Reviews user wrote
  cart                Cart?              // User's shopping cart
  conversationsAsSender   Conversation[] @relation("Sender")
  conversationsAsReceiver Conversation[] @relation("Receiver")
  sentMessages        Message[]          // Messages user sent
  
  // Performance indexes (email and phoneNumber already indexed via @unique)
  @@index([isSeller])
  @@index([isVerified])
  @@index([region])
  
  @@map("users")
}

// Category Entity - Product categorization
model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  categoryName String   @unique
  description String?
  
  // Relationships
  products    Product[]
  
  @@map("categories")
}

// Product Entity - Main product catalog
model Product {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  productName  String
  description  String
  price        Float    // Stored in Ghana Cedi (GHS)
  stockQuantity Int     // Available quantity
  imageURL     String?
  sku          String?
  brand        String?
  weight       Float?   // For shipping (kg)
  galleryImages String[] @default([])
  highlights   String[] @default([])
  deliveryInfo String?
  returnPolicy String?
  videoURL     String?
  specifications Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Foreign Keys
  categoryId   String   @db.ObjectId
  ownerId      String   @db.ObjectId  // User who owns/sells this product
  
  // Relationships
  category       Category        @relation(fields: [categoryId], references: [id])
  owner          User            @relation(fields: [ownerId], references: [id])
  reviews        Review[]
  cartItems      CartItem[]
  conversations  Conversation[]
  
  // Performance indexes
  @@index([categoryId])
  @@index([ownerId])
  @@index([price])
  @@index([createdAt])
  @@index([isActive])
  @@index([sku])
  
  @@map("products")
}

// Review Entity - Product reviews and ratings
model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  rating     Int      // 1-5 star rating
  comment    String?
  createdAt  DateTime @default(now())
  
  // Foreign Keys
  userId     String   @db.ObjectId
  productId  String   @db.ObjectId
  
  // Relationships
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
  
  @@index([userId])
  @@index([productId])
  @@index([rating])
  
  @@map("reviews")
}

// Cart Entity - Shopping cart management
model Cart {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  createdAt  DateTime   @default(now())
  
  // Foreign Keys
  userId     String     @unique @db.ObjectId
  
  // Relationships
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  
  @@map("carts")
}

// CartItem Entity - Items in shopping cart
model CartItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  quantity  Int
  addedAt   DateTime @default(now())
  
  // Foreign Keys
  cartId    String   @db.ObjectId
  productId String   @db.ObjectId
  
  // Relationships
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  // Prevent duplicate products in same cart
  @@unique([cartId, productId])
  @@index([cartId])
  @@index([productId])
  
  @@map("cartItems")
}

// Conversation Entity - Chat threads between any two users
model Conversation {
  id              String    @id @default(auto()) @map("_id") @db.ObjectId
  subject         String    // Conversation subject (e.g., product name)
  lastMessageAt   DateTime  @default(now())
  senderUnread    Int       @default(0) // Unread count for sender
  receiverUnread  Int       @default(0) // Unread count for receiver
  createdAt       DateTime  @default(now())
  
  // Foreign Keys
  senderId        String    @db.ObjectId  // User who initiated conversation
  receiverId      String    @db.ObjectId  // User who received the conversation
  productId       String?   @db.ObjectId  // Optional - product being discussed
  
  // Relationships
  sender          User      @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver        User      @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)
  product         Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  messages        Message[]
  
  // Performance indexes
  @@index([senderId])
  @@index([receiverId])
  @@index([productId])
  @@index([lastMessageAt])
  @@index([senderUnread])
  @@index([receiverUnread])
  
  @@map("conversations")
}

// Message Entity - Individual messages within conversations
model Message {
  id              String       @id @default(auto()) @map("_id") @db.ObjectId
  content         String       // Message text content
  isRead          Boolean      @default(false)
  createdAt       DateTime     @default(now())
  
  // Foreign Keys
  conversationId  String       @db.ObjectId
  senderId        String       @db.ObjectId  // User who sent this message
  
  // Relationships
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender          User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  // Performance indexes
  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([isRead])
  
  @@map("messages")
}

